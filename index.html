<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR to PC Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-xl text-center">
        <h1 class="text-3xl font-bold mb-6">Scan QR Code to PC</h1>
        <div id="reader" class="w-full h-auto mb-6"></div>
        <div id="output" class="p-4 bg-gray-700 rounded-lg break-words text-left">
            <p class="font-semibold text-lg">Scanned Data:</p>
            <p id="qr-result" class="mt-2 text-gray-300"></p>
        </div>
        <div id="status-message" class="mt-4 p-2 rounded-lg text-sm bg-gray-700 text-gray-400">
            Scanning for QR codes...
        </div>
        <div class="mt-6 flex flex-col items-center">
            <p class="text-xs text-gray-500 mb-2">PC Server IP Address</p>
            <input 
                type="text" 
                id="ip-input" 
                placeholder="e.g., 192.168.1.100" 
                class="w-full max-w-sm p-2 rounded-lg bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <p class="text-xs text-gray-500 mt-4 mb-2">PC Server Port</p>
            <input 
                type="number" 
                id="port-input" 
                value="5000" 
                class="w-full max-w-sm p-2 rounded-lg bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <button 
                id="save-button" 
                class="mt-4 px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors"
            >
                Save
            </button>
        </div>
    </div>

    <script>
        // Use a function to safely get a value from localStorage
        const getLocalStorageItem = (key, defaultValue) => {
            try {
                return localStorage.getItem(key) || defaultValue;
            } catch (e) {
                console.error("Error accessing localStorage", e);
                return defaultValue;
            }
        };

        const ipInput = document.getElementById('ip-input');
        const portInput = document.getElementById('port-input');
        const saveButton = document.getElementById('save-button');
        const qrResult = document.getElementById('qr-result');
        const statusMessage = document.getElementById('status-message');

        // Load saved settings on startup
        let pcIp = getLocalStorageItem('pcIp', '');
        let pcPort = getLocalStorageItem('pcPort', '5000');
        
        ipInput.value = pcIp;
        portInput.value = pcPort;
        
        saveButton.addEventListener('click', () => {
            pcIp = ipInput.value;
            pcPort = portInput.value;
            
            // Save settings to local storage
            try {
                localStorage.setItem('pcIp', pcIp);
                localStorage.setItem('pcPort', pcPort);
                statusMessage.textContent = `Settings saved. Ready to scan to ${pcIp}:${pcPort}`;
                statusMessage.classList.add('bg-green-800', 'text-green-200');
                statusMessage.classList.remove('bg-gray-700', 'text-gray-400');
            } catch (e) {
                console.error("Could not save settings.", e);
                statusMessage.textContent = "Error saving settings.";
                statusMessage.classList.add('bg-red-800', 'text-red-200');
                statusMessage.classList.remove('bg-gray-700', 'text-gray-400');
            }
        });

        // Function to send data to the PC
        async function sendDataToPC(data) {
            if (!pcIp || !pcPort) {
                statusMessage.textContent = "Please enter PC IP and Port first!";
                statusMessage.classList.add('bg-red-800', 'text-red-200');
                statusMessage.classList.remove('bg-gray-700', 'text-gray-400');
                return;
            }

            try {
                const response = await fetch(`http://${pcIp}:${pcPort}`, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: data
                });
                console.log('Data sent successfully', response);
                statusMessage.textContent = `Scanned data sent to PC!`;
                statusMessage.classList.add('bg-green-800', 'text-green-200');
                statusMessage.classList.remove('bg-red-800', 'text-red-200', 'bg-gray-700', 'text-gray-400');
            } catch (error) {
                console.error('Error sending data to PC:', error);
                statusMessage.textContent = `Failed to send data to PC. Is the server running on ${pcIp}:${pcPort}?`;
                statusMessage.classList.add('bg-red-800', 'text-red-200');
                statusMessage.classList.remove('bg-green-800', 'text-green-200', 'bg-gray-700', 'text-gray-400');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan successful: ${decodedText}`);
            qrResult.textContent = decodedText;
            sendDataToPC(decodedText);
            
            // Re-start the scanner after a brief delay
            html5QrcodeScanner.pause();
            setTimeout(() => {
                html5QrcodeScanner.resume();
            }, 2000); // Wait 2 seconds before resuming scan
        }

        function onScanError(errorMessage) {
            // console.warn(`Code scan error: ${errorMessage}`);
        }

        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false
        );

        // Start the scanner after the page loads
        document.addEventListener('DOMContentLoaded', () => {
            html5QrcodeScanner.render(onScanSuccess, onScanError);
            if (pcIp && pcPort) {
                 statusMessage.textContent = `Ready to scan to ${pcIp}:${pcPort}`;
            }
        });
    </script>
</body>
</html>
